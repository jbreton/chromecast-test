<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    body {
      margin: 0;
      overflow:hidden;
    }
    div{
      height:720PX;
      width:1280PX;
    }
    iframe{
      height:100%;
      width:100%;
    }
  </style>
  <title>Grafana Dashboard Playlist</title>
</head>
<body>
<div id="dashboards"></div>
<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">
	window.onload = function() {
		window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
		console.log('Starting Receiver Manager');

		castReceiverManager.onReady = function(event) {
			console.log('Received Ready event: ' + JSON.stringify(event.data));
			window.castReceiverManager.setApplicationState('Application status is ready...');
		};
		window.messageBus = window.castReceiverManager.getCastMessageBus('urn:x-cast:io.github.jbreton.cast.sample');


		window.messageBus.onMessage = function(event) {
			console.log('Message [' + event.senderId + ']: ' + event.data);

			var payload = JSON.parse(atob(event.data));
			var dashboards = payload.dashboards.split(',');

			$("#dashboards").empty();

			var iframes = [];

			for (var i = 0; i < dashboards.length; i++) {
				var url = dashboards[i];
				var iframe = $('iframe');
				iframe.id = 'casted_frame_' + i;
				iframe.frameBorder = 0;
				iframe.src = payload.hostname + "/" + payload.loginUrl + payload.token;
				iframe.hide();
				iframes[i] = iframe;
				$("#dashboards").append(iframe);
				setTimeout(function() {
					iframes[i].src = payload.hostname + "/" + url;
				}, 10000);
			}

			window.frame_count = dashboards.length;
			window.loop_index = 0;
			if(window.loop) {
				clearInterval(window.loop);
			}
			window.loop = setInterval(function() {
				$('#casted_frame_' + window.loop_index).hide();
				window.loop_index = (((window.loop_index + 1) === window.frame_count) ? 0 : window.loop_index + 1);
				$('#casted_frame_' + window.loop_index).show();
			}, payload.duration);

			window.messageBus.send(event.senderId, event.data);
		}
		window.castReceiverManager.start();
	}
</script>
</body>
</html>